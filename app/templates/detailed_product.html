{% extends "base.html" %}

{% block content %}
  <div class="container mt-5">
    <h2>{{ name }} Details</h2>

    <div class="row">
      <div class="col-md-6">
        <img src="{{ image_url }}" alt="{{ name }} Image" class="img-fluid">
      </div>
      <div class="col-md-6">
        <p><strong>Description:</strong> {{ description }}</p>
        <p><strong>Price:</strong> ${{ price }}</p>
        <p><strong>Category:</strong> {{ category }}</p>
        <p>
          <strong>Availability:</strong>
          <span class="{% if available %}text-success{% else %}text-danger{% endif %}">
            {% if available %}
              In Stock
            {% else %}
              Out of Stock
            {% endif %}
          </span>
        </p>
        <p><strong>Average Rating:</strong> {{ '{:.2f}/5'.format(avg_stars) if avg_stars is not none else 'Not rated' }}</p>
        {% if current_user.is_authenticated %}
        <form METHOD="POST" id="addToCartForm">
          <label for="sellerSelect">Select Seller:</label>
          <select class="form-control" id="sellerSelect" name="seller_id" style="width: 500px;">
              <option value="" disabled selected>Select a Seller</option>
              {% for seller in seller_info %}
                  <option value="{{ seller.uid }}" data-stock="{{ seller.quantity }}">{{ seller.name }}</option>
              {% endfor %}
          </select>
          <br>
          <br>
          <label for="quantitySelect">Quantity:</label>
          <input type="number" id="quantitySelect" name="quantity" value="1" min="1">
          <br>
          <br>
          <input type="hidden" id="productId" name="pid" value="{{ id }}">
          <input type="hidden" id="userId" name="user_id" value="{{ current_user.id }}">
          <input type="hidden" id="sellerInput" name="seller_id" value="{{ seller_id }}"> <!-- Updated to an empty value initially -->
          <input type="hidden" id="quantityInput" name="quantity" value="1" min="1">
          <button type="submit" class="btn btn-primary" onclick="submitAddToCart();">Add to Cart</button>
          <script>
              function submitAddToCart() {
                document.getElementById("addToCartForm").action = "{{ url_for('products.add_to_cart', pid=id) }}"
                document.getElementById("addToCartForm").submit();
              }
          </script>
        </form>
          {% if success == 1 %}
          <div class="alert alert-success" role="alert">
            {{ success_message }}
          </div>
          {% endif %}
        </form>
      {% endif %}
      </div>
    </div>
    <br>
    <h3>Sellers and Stock Quantities</h3>
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Seller ID</th>
          <th scope="col">Seller Name</th>
          <th scope="col">Quantity in Stock</th>
        </tr>
      </thead>
      <tbody>
        {% for seller in seller_info %}
          <tr>
            <td>{{ seller.uid }}</td>
            <td>{{ seller.name }}</td>
            <td>{{ seller.quantity }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <script>
      function updateQuantity() {
        var selectedSeller = document.getElementById("sellerSelect");
        var quantityInput = document.getElementById("quantityInput");
        var selectedOption = selectedSeller.options[selectedSeller.selectedIndex];

        // Check if a seller is selected
        if (selectedOption.value === "") {
          alert("Please select a seller first.");
          quantityInput.value = 1;  // Reset quantity to 1 when no seller is selected
          return;
        }

        var maxQuantity = selectedOption.getAttribute("data-stock");
        quantityInput.setAttribute("max", maxQuantity);
        quantityInput.value = 1;  // Reset quantity to 1 when the seller changes
      }

      function validateForm() {
        var selectedSeller = document.getElementById("sellerSelect");
        var quantityInput = document.getElementById("quantityInput");
        var selectedOption = selectedSeller.options[selectedSeller.selectedIndex];
        var maxQuantity = selectedOption.getAttribute("data-stock");
        var selectedQuantity = quantityInput.value;

        // Check if a seller is selected
        if (selectedOption.value === "") {
          alert("Please select a seller first.");
          return false;
        }

        // Check if the quantity exceeds the available stock
        if (selectedQuantity > maxQuantity) {
          alert("Quantity exceeds the available stock. Please select a lower quantity.");
          return false;
        }

        // Form is valid, proceed with submission
        return true;
      }
    </script>
  </div>
{% endblock %}
